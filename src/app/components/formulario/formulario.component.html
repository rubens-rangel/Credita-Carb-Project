<div class="card">
  <h2>üìù Formul√°rio de C√°lculo de Cr√©dito de Carbono</h2>
  
  <!-- Informa√ß√£o do Evento -->
  <div *ngIf="evento" class="evento-info">
    <h4>üéØ Evento Configurado</h4>
    <p><strong>Nome:</strong> {{ evento.nomeEvento || 'Evento' }}</p>
    <p><strong>Local:</strong> {{ evento.cidade }}, {{ evento.estado }}, {{ evento.pais }}</p>
    <p *ngIf="evento.dataInicio"><strong>Data:</strong> {{ evento.dataInicio }} <span *ngIf="evento.dataFim">at√© {{ evento.dataFim }}</span></p>
  </div>
  
  <p style="margin-bottom: 20px; color: #666;">
    Preencha os dados da sua viagem para calcular a emiss√£o de CO‚ÇÇ e os cr√©ditos de carbono gerados.
  </p>

  <form [formGroup]="formulario" (ngSubmit)="calcular()">
    <!-- Dados Pessoais -->
    <h3 style="margin-top: 30px; margin-bottom: 15px; color: #2d8659;">üë§ Dados Pessoais</h3>
    <div class="form-row">
      <div class="form-group">
        <label>Nome Completo *</label>
        <input type="text" formControlName="nome" [class.error]="campoInvalido('nome')">
        <div class="error-message" *ngIf="campoInvalido('nome')">
          Nome √© obrigat√≥rio (m√≠nimo 3 caracteres)
        </div>
      </div>
      <div class="form-group">
        <label>E-mail *</label>
        <input type="email" formControlName="email" [class.error]="campoInvalido('email')">
        <div class="error-message" *ngIf="campoInvalido('email')">
          E-mail inv√°lido
        </div>
      </div>
    </div>
    <div class="form-row">
      <div class="form-group">
        <label>CPF *</label>
        <input type="text" formControlName="cpf" placeholder="000.000.000-00" [class.error]="campoInvalido('cpf')">
        <div class="error-message" *ngIf="campoInvalido('cpf')">
          CPF √© obrigat√≥rio
        </div>
      </div>
      <div class="form-group">
        <label>Telefone *</label>
        <input type="text" formControlName="telefone" placeholder="(00) 00000-0000" [class.error]="campoInvalido('telefone')">
        <div class="error-message" *ngIf="campoInvalido('telefone')">
          Telefone √© obrigat√≥rio
        </div>
      </div>
    </div>

    <!-- Trechos de Viagem -->
    <h3 style="margin-top: 30px; margin-bottom: 15px; color: #2d8659;">üöó Trechos de Viagem</h3>
    <p style="margin-bottom: 15px; color: #666;">
      Adicione os meios de transporte utilizados na viagem. Exemplo: Avi√£o at√© a cidade + Carro at√© o evento.
    </p>

    <div *ngFor="let trecho of trechos; let i = index; trackBy: trackByTrechoIndex" class="card" style="background: #f8f9fa; margin-bottom: 15px;">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
        <h4 style="color: #2d8659; margin: 0;">Trecho {{ i + 1 }}</h4>
        <button *ngIf="trechos.length > 1" type="button" (click)="removerTrecho(i)" class="btn-danger" style="padding: 6px 12px; font-size: 14px;">
          Remover
        </button>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label>Meio de Transporte *</label>
          <select [ngModel]="trecho.meioTransporte" (ngModelChange)="atualizarTrecho(i, 'meioTransporte', $event)" [ngModelOptions]="{standalone: true}">
            <option value="">Selecione</option>
            <option *ngFor="let meio of meiosTransporte" [value]="meio.value">{{ meio.label }}</option>
          </select>
        </div>
        <div class="form-group">
          <label>Dist√¢ncia (km)</label>
          <input type="number" [ngModel]="trecho.distanciaKm || ''" (ngModelChange)="atualizarTrecho(i, 'distanciaKm', $event ? +$event : undefined)" [ngModelOptions]="{standalone: true}" min="0" placeholder="Deixe em branco para c√°lculo autom√°tico">
          <small style="color: #666;">Se n√£o preenchido, ser√° calculado automaticamente</small>
        </div>
      </div>

      <!-- Origem para Avi√£o e Trem -->
      <div *ngIf="mostrarCamposAviao(trecho) || trecho.meioTransporte === 'trem'" class="form-row" style="margin-top: 15px;">
        <h5 style="width: 100%; margin-bottom: 10px; color: #2d8659;">üìç Origem do Trecho</h5>
        <div class="form-group">
          <label>Estado de Origem *</label>
          <select [ngModel]="trecho.origemEstado || ''" (ngModelChange)="atualizarTrecho(i, 'origemEstado', $event); configurarAutocompleteTrecho(i, $event)" [ngModelOptions]="{standalone: true}">
            <option value="">Selecione</option>
            <option *ngFor="let estado of estadosBrasil" [value]="estado">{{ estado }}</option>
          </select>
        </div>
        <div class="form-group autocomplete-wrapper" style="flex: 2;">
          <label>Cidade de Origem *</label>
          <input type="text" 
                 [ngModel]="trecho.origemCidade || ''" 
                 (ngModelChange)="atualizarTrecho(i, 'origemCidade', $event)" 
                 [ngModelOptions]="{standalone: true}"
                 (focus)="mostrarAutocompletePorTrecho[i] = true"
                 (blur)="esconderAutocompleteTrecho(i)">
          <div class="autocomplete-list" *ngIf="mostrarAutocompletePorTrecho[i] && filtrarCidadesTrecho(i, trecho.origemCidade || '').length > 0">
            <div class="autocomplete-item" 
                 *ngFor="let cidade of filtrarCidadesTrecho(i, trecho.origemCidade || '')"
                 (click)="selecionarCidadeTrecho(i, cidade)">
              {{ cidade.nome }}
            </div>
          </div>
        </div>
      </div>

      <!-- Destino para Avi√£o e Trem (padr√£o evento, mas alter√°vel) -->
      <div *ngIf="mostrarCamposAviao(trecho) || trecho.meioTransporte === 'trem'" class="form-row" style="margin-top: 15px;">
        <h5 style="width: 100%; margin-bottom: 10px; color: #2d8659;">üéØ Destino do Trecho</h5>
        <div class="form-group">
          <label>Estado de Destino</label>
          <select [ngModel]="trecho.destinoEstado || evento?.estado || ''" (ngModelChange)="atualizarTrecho(i, 'destinoEstado', $event)" [ngModelOptions]="{standalone: true}">
            <option value="">Selecione</option>
            <option *ngFor="let estado of estadosBrasil" [value]="estado">{{ estado }}</option>
          </select>
          <small style="color: #666;">Padr√£o: {{ evento?.cidade }}, {{ evento?.estado }}</small>
        </div>
        <div class="form-group" style="flex: 2;">
          <label>Cidade de Destino</label>
          <input type="text" 
                 [ngModel]="trecho.destinoCidade || evento?.cidade || ''" 
                 (ngModelChange)="atualizarTrecho(i, 'destinoCidade', $event)" 
                 [ngModelOptions]="{standalone: true}"
                 placeholder="Padr√£o: cidade do evento">
        </div>
      </div>

      <!-- CEP de Origem para Carro, Moto, √înibus -->
      <div *ngIf="mostrarCamposCarro(trecho) || trecho.meioTransporte === 'motocicleta' || trecho.meioTransporte === 'onibus'" class="form-row" style="margin-top: 15px;">
        <h5 style="width: 100%; margin-bottom: 10px; color: #2d8659;">üìç Origem do Trecho</h5>
        <div class="form-group">
          <label>CEP de Origem *</label>
          <input type="text" 
                 [ngModel]="trecho.cepOrigem || ''" 
                 (ngModelChange)="atualizarCepTrecho(i, $event)" 
                 [ngModelOptions]="{standalone: true}"
                 placeholder="00000-000" 
                 maxlength="9">
          <small style="color: #666;">CEP de onde voc√™ parte neste trecho</small>
          <div *ngIf="enderecosCEP[i]" style="margin-top: 5px; padding: 8px; background: #e8f5e9; border-radius: 4px; font-size: 0.9em;">
            <strong>Endere√ßo encontrado:</strong> {{ enderecosCEP[i].logradouro }}, {{ enderecosCEP[i].bairro }}, {{ enderecosCEP[i].localidade }}-{{ enderecosCEP[i].uf }}
          </div>
        </div>
      </div>

      <!-- Campos espec√≠ficos para Carro -->
      <div *ngIf="mostrarCamposCarro(trecho)" class="form-row" style="margin-top: 15px;">
        <div class="form-group">
          <label>Tipo de Combust√≠vel *</label>
          <select [ngModel]="trecho.tipoCombustivel || ''" (ngModelChange)="atualizarTrecho(i, 'tipoCombustivel', $event)" [ngModelOptions]="{standalone: true}">
            <option value="">Selecione</option>
            <option *ngFor="let tipo of tiposCombustivel" [value]="tipo.value">{{ tipo.label }}</option>
          </select>
        </div>
        <div class="form-group">
          <label>N√∫mero de Passageiros *</label>
          <input type="number" [ngModel]="trecho.numeroPassageiros || 1" (ngModelChange)="atualizarTrecho(i, 'numeroPassageiros', $event ? +$event : 1)" [ngModelOptions]="{standalone: true}" min="1">
        </div>
        <div class="form-group">
          <label>Consumo M√©dio (km/l)</label>
          <input type="number" [ngModel]="trecho.consumoMedio || ''" (ngModelChange)="atualizarTrecho(i, 'consumoMedio', $event ? +$event : undefined)" [ngModelOptions]="{standalone: true}" min="0" placeholder="Opcional">
        </div>
      </div>

      <!-- Campos espec√≠ficos para Avi√£o -->
      <div *ngIf="mostrarCamposAviao(trecho)" class="form-row" style="margin-top: 15px;">
        <div class="form-group">
          <label>Classe do Voo *</label>
          <select [ngModel]="trecho.classeVoo || ''" (ngModelChange)="atualizarTrecho(i, 'classeVoo', $event)" [ngModelOptions]="{standalone: true}">
            <option value="">Selecione</option>
            <option *ngFor="let classe of classesVoo" [value]="classe.value">{{ classe.label }}</option>
          </select>
        </div>
      </div>
    </div>

    <button type="button" (click)="adicionarTrecho()" class="btn-secondary" style="margin-bottom: 20px;">
      ‚ûï Adicionar Outro Trecho
    </button>

    <!-- Datas -->
    <h3 style="margin-top: 30px; margin-bottom: 15px; color: #2d8659;">üìÖ Datas da Viagem</h3>
    <div class="form-row">
      <div class="form-group">
        <label>Data da Viagem *</label>
        <input type="date" formControlName="dataViagem" [class.error]="campoInvalido('dataViagem')">
        <div class="error-message" *ngIf="campoInvalido('dataViagem')">
          Data da viagem √© obrigat√≥ria
        </div>
      </div>
      <div class="form-group">
        <label>
          <input type="checkbox" formControlName="idaEVolta" style="width: auto; margin-right: 8px;">
          Ida e Volta
        </label>
      </div>
      <div class="form-group" *ngIf="formulario.get('idaEVolta')?.value">
        <label>Data de Retorno *</label>
        <input type="date" formControlName="dataRetorno" [class.error]="campoInvalido('dataRetorno')">
        <div class="error-message" *ngIf="campoInvalido('dataRetorno')">
          Data de retorno √© obrigat√≥ria
        </div>
      </div>
    </div>

    <!-- Observa√ß√µes -->
    <div class="form-group" style="margin-top: 20px;">
      <label>Observa√ß√µes</label>
      <textarea formControlName="observacoes" rows="3" placeholder="Informa√ß√µes adicionais sobre a viagem..."></textarea>
    </div>

    <!-- Bot√µes -->
    <div style="margin-top: 30px; display: flex; gap: 15px;">
      <button type="submit" [disabled]="calculado || carregando">
        <span *ngIf="!carregando">üî¢ Calcular Emiss√£o</span>
        <span *ngIf="carregando">‚è≥ Calculando...</span>
      </button>
      <button type="button" (click)="resetarFormulario()" class="btn-secondary" [disabled]="carregando">üîÑ Limpar</button>
    </div>
  </form>

  <!-- Loading -->
  <div *ngIf="carregando" class="loading">
    <p>‚è≥ Calculando dist√¢ncia e emiss√£o de CO‚ÇÇ...</p>
  </div>

  <!-- Resultado do C√°lculo -->
  <div *ngIf="calculado && resultado && !carregando" class="result-card">
    <h3>üìä Resultado do C√°lculo</h3>
    <div class="result-value">{{ resultado.emissaoCO2 }} kg CO‚ÇÇ</div>
    <p style="margin: 15px 0;">
      <strong>Dist√¢ncia Total:</strong> {{ resultado.distanciaTotal }} km
    </p>
    
    <!-- Detalhes dos Trechos -->
    <div *ngIf="resultado.trechos && resultado.trechos.length > 0" style="margin-top: 20px; padding-top: 15px; border-top: 1px solid rgba(255,255,255,0.3);">
      <h4 style="color: white; margin-bottom: 10px;">Detalhes por Trecho:</h4>
      <div *ngFor="let item of resultado.trechos; let i = index" style="margin-bottom: 10px; padding: 10px; background: rgba(255,255,255,0.1); border-radius: 6px;">
        <p style="margin: 5px 0;"><strong>Trecho {{ i + 1 }}:</strong> {{ formatarMeioTransporte(item.trecho.meioTransporte) }}</p>
        <p style="margin: 5px 0;">Dist√¢ncia: {{ item.distancia }} km | Emiss√£o: {{ item.emissao }} kg CO‚ÇÇ</p>
      </div>
    </div>
    <p style="margin: 15px 0;">
      <strong>Cr√©ditos de Carbono:</strong> {{ resultado.creditosCarbono }} toneladas de CO‚ÇÇ equivalente
    </p>
    <p style="margin: 10px 0;">
      <strong>Equivalente a:</strong> {{ resultado.equivalenteArvores }} √°rvores plantadas
    </p>
    <p style="margin: 10px 0;">
      <strong>Ou:</strong> {{ resultado.equivalenteKmCarro }} km de carro
    </p>
    
    <button type="button" (click)="enviar()" [disabled]="enviado" style="margin-top: 20px;">
      {{ enviado ? '‚úÖ Enviado com Sucesso!' : 'üíæ Salvar C√°lculo' }}
    </button>
    
    <div *ngIf="enviado" class="success-message" style="margin-top: 10px; color: white;">
      Seu c√°lculo foi salvo! Voc√™ pode visualiz√°-lo na p√°gina de administrador.
    </div>
  </div>
</div>

