<div class="card">
  <h2>ğŸŒ Calcule Seu Impacto Ambiental</h2>
  
  <!-- InformaÃ§Ã£o do Evento -->
  <div *ngIf="evento" class="evento-info">
    <h4>ğŸ¯ Evento Configurado</h4>
    <p><strong>Nome:</strong> {{ evento.nomeEvento || 'Evento' }}</p>
    <p><strong>Local:</strong> {{ evento.cidade }}, {{ evento.estado }}, {{ evento.pais }}</p>
    <p *ngIf="evento.dataInicio"><strong>Data:</strong> {{ evento.dataInicio }} <span *ngIf="evento.dataFim">atÃ© {{ evento.dataFim }}</span></p>
  </div>
  
  <p style="margin-bottom: 20px; color: #666; font-size: 1.1em; line-height: 1.6;">
    Descubra quantas Ã¡rvores precisam ser plantadas para compensar sua viagem! ğŸ’š<br>
    Em poucos minutos, vocÃª saberÃ¡ seu impacto ambiental e como contribuir para um planeta mais verde.
  </p>

  <form [formGroup]="formulario" (ngSubmit)="calcular()">
    <!-- Dados Pessoais -->
    <h3 style="margin-top: 30px; margin-bottom: 15px; color: #2d8659;">ğŸ‘¤ Dados Pessoais</h3>
    <div class="form-row">
      <div class="form-group">
        <label>Nome Completo *</label>
        <input type="text" formControlName="nome" [class.error]="campoInvalido('nome')">
        <div class="error-message" *ngIf="campoInvalido('nome')">
          Nome Ã© obrigatÃ³rio (mÃ­nimo 3 caracteres)
        </div>
      </div>
      <div class="form-group">
        <label>E-mail *</label>
        <input type="email" formControlName="email" [class.error]="campoInvalido('email')">
        <div class="error-message" *ngIf="campoInvalido('email')">
          E-mail invÃ¡lido
        </div>
      </div>
    </div>
    <div class="form-row">
      <div class="form-group">
        <label>CPF *</label>
        <input type="text" formControlName="cpf" placeholder="000.000.000-00" [class.error]="campoInvalido('cpf')">
        <div class="error-message" *ngIf="campoInvalido('cpf')">
          CPF Ã© obrigatÃ³rio
        </div>
      </div>
      <div class="form-group">
        <label>Telefone *</label>
        <input type="text" formControlName="telefone" placeholder="(00) 00000-0000" [class.error]="campoInvalido('telefone')">
        <div class="error-message" *ngIf="campoInvalido('telefone')">
          Telefone Ã© obrigatÃ³rio
        </div>
      </div>
    </div>

    <!-- Trechos de Viagem -->
    <h3 style="margin-top: 30px; margin-bottom: 15px; color: #2d8659;">ğŸš— Trechos de Viagem</h3>
    <p style="margin-bottom: 15px; color: #666;">
      Adicione os meios de transporte utilizados na viagem. Exemplo: AviÃ£o atÃ© a cidade + Carro atÃ© o evento.
    </p>

    <div *ngFor="let trecho of trechos; let i = index; trackBy: trackByTrechoIndex" class="card" style="background: #f8f9fa; margin-bottom: 15px;">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
        <h4 style="color: #2d8659; margin: 0;">Trecho {{ i + 1 }}</h4>
        <button *ngIf="trechos.length > 1" type="button" (click)="removerTrecho(i)" class="btn-danger" style="padding: 6px 12px; font-size: 14px;">
          Remover
        </button>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label>Meio de Transporte *</label>
          <select [ngModel]="trecho.meioTransporte" (ngModelChange)="atualizarTrecho(i, 'meioTransporte', $event)" [ngModelOptions]="{standalone: true}">
            <option value="">Selecione</option>
            <option *ngFor="let meio of meiosTransporte" [value]="meio.value">{{ meio.label }}</option>
          </select>
        </div>
        <div class="form-group">
          <label>DistÃ¢ncia (km)</label>
          <input type="number" [ngModel]="trecho.distanciaKm || ''" (ngModelChange)="atualizarTrecho(i, 'distanciaKm', $event ? +$event : undefined)" [ngModelOptions]="{standalone: true}" min="0" placeholder="Deixe em branco para cÃ¡lculo automÃ¡tico">
          <small style="color: #666;">Se nÃ£o preenchido, serÃ¡ calculado automaticamente</small>
        </div>
      </div>

      <!-- Origem para AviÃ£o e Trem -->
      <div *ngIf="mostrarCamposAviao(trecho) || trecho.meioTransporte === 'trem'" class="form-row" style="margin-top: 15px;">
        <h5 style="width: 100%; margin-bottom: 10px; color: #2d8659;">ğŸ“ Origem do Trecho</h5>
        <div class="form-group">
          <label>Estado de Origem *</label>
          <select [ngModel]="trecho.origemEstado || ''" (ngModelChange)="atualizarTrecho(i, 'origemEstado', $event); configurarAutocompleteTrecho(i, $event)" [ngModelOptions]="{standalone: true}">
            <option value="">Selecione</option>
            <option *ngFor="let estado of estadosBrasil" [value]="estado">{{ estado }}</option>
          </select>
        </div>
        <div class="form-group autocomplete-wrapper" style="flex: 2;">
          <label>Cidade de Origem *</label>
          <input type="text" 
                 [ngModel]="trecho.origemCidade || ''" 
                 (ngModelChange)="atualizarTrecho(i, 'origemCidade', $event)" 
                 [ngModelOptions]="{standalone: true}"
                 (focus)="mostrarAutocompletePorTrecho[i] = true"
                 (blur)="esconderAutocompleteTrecho(i)">
          <div class="autocomplete-list" *ngIf="mostrarAutocompletePorTrecho[i] && filtrarCidadesTrecho(i, trecho.origemCidade || '').length > 0">
            <div class="autocomplete-item" 
                 *ngFor="let cidade of filtrarCidadesTrecho(i, trecho.origemCidade || '')"
                 (click)="selecionarCidadeTrecho(i, cidade)">
              {{ cidade.nome }}
            </div>
          </div>
        </div>
      </div>

      <!-- Destino para AviÃ£o e Trem (padrÃ£o evento, mas alterÃ¡vel) -->
      <div *ngIf="mostrarCamposAviao(trecho) || trecho.meioTransporte === 'trem'" class="form-row" style="margin-top: 15px;">
        <h5 style="width: 100%; margin-bottom: 10px; color: #2d8659;">ğŸ¯ Destino do Trecho</h5>
        <div class="form-group">
          <label>Estado de Destino</label>
          <select [ngModel]="trecho.destinoEstado || evento?.estado || ''" (ngModelChange)="atualizarTrecho(i, 'destinoEstado', $event)" [ngModelOptions]="{standalone: true}">
            <option value="">Selecione</option>
            <option *ngFor="let estado of estadosBrasil" [value]="estado">{{ estado }}</option>
          </select>
          <small style="color: #666;">PadrÃ£o: {{ evento?.cidade }}, {{ evento?.estado }}</small>
        </div>
        <div class="form-group" style="flex: 2;">
          <label>Cidade de Destino</label>
          <input type="text" 
                 [ngModel]="trecho.destinoCidade || evento?.cidade || ''" 
                 (ngModelChange)="atualizarTrecho(i, 'destinoCidade', $event)" 
                 [ngModelOptions]="{standalone: true}"
                 placeholder="PadrÃ£o: cidade do evento">
        </div>
      </div>

      <!-- CEP de Origem para Carro, Moto, Ã”nibus -->
      <div *ngIf="mostrarCamposCarro(trecho) || trecho.meioTransporte === 'motocicleta' || trecho.meioTransporte === 'onibus'" class="form-row" style="margin-top: 15px;">
        <h5 style="width: 100%; margin-bottom: 10px; color: #2d8659;">ğŸ“ Origem do Trecho</h5>
        <div class="form-group">
          <label>CEP de Origem *</label>
          <input type="text" 
                 [ngModel]="trecho.cepOrigem || ''" 
                 (ngModelChange)="atualizarCepTrecho(i, $event)" 
                 [ngModelOptions]="{standalone: true}"
                 placeholder="00000-000" 
                 maxlength="9">
          <small style="color: #666;">CEP de onde vocÃª parte neste trecho</small>
          <div *ngIf="enderecosCEP[i]" style="margin-top: 5px; padding: 8px; background: #e8f5e9; border-radius: 4px; font-size: 0.9em;">
            <strong>EndereÃ§o encontrado:</strong> {{ enderecosCEP[i].logradouro }}, {{ enderecosCEP[i].bairro }}, {{ enderecosCEP[i].localidade }}-{{ enderecosCEP[i].uf }}
          </div>
        </div>
      </div>

      <!-- Campos especÃ­ficos para Carro -->
      <div *ngIf="mostrarCamposCarro(trecho)" class="form-row" style="margin-top: 15px;">
        <div class="form-group">
          <label>Tipo de CombustÃ­vel *</label>
          <select [ngModel]="trecho.tipoCombustivel || ''" (ngModelChange)="atualizarTrecho(i, 'tipoCombustivel', $event)" [ngModelOptions]="{standalone: true}">
            <option value="">Selecione</option>
            <option *ngFor="let tipo of tiposCombustivel" [value]="tipo.value">{{ tipo.label }}</option>
          </select>
        </div>
        <div class="form-group">
          <label>NÃºmero de Passageiros *</label>
          <input type="number" [ngModel]="trecho.numeroPassageiros || 1" (ngModelChange)="atualizarTrecho(i, 'numeroPassageiros', $event ? +$event : 1)" [ngModelOptions]="{standalone: true}" min="1">
        </div>
        <div class="form-group">
          <label>Consumo MÃ©dio (km/l)</label>
          <input type="number" [ngModel]="trecho.consumoMedio || ''" (ngModelChange)="atualizarTrecho(i, 'consumoMedio', $event ? +$event : undefined)" [ngModelOptions]="{standalone: true}" min="0" placeholder="Opcional">
        </div>
      </div>

      <!-- Campos especÃ­ficos para AviÃ£o -->
      <div *ngIf="mostrarCamposAviao(trecho)" class="form-row" style="margin-top: 15px;">
        <div class="form-group">
          <label>Classe do Voo *</label>
          <select [ngModel]="trecho.classeVoo || ''" (ngModelChange)="atualizarTrecho(i, 'classeVoo', $event)" [ngModelOptions]="{standalone: true}">
            <option value="">Selecione</option>
            <option *ngFor="let classe of classesVoo" [value]="classe.value">{{ classe.label }}</option>
          </select>
        </div>
      </div>
    </div>

    <button type="button" (click)="adicionarTrecho()" class="btn-secondary" style="margin-bottom: 20px;">
      â• Adicionar Outro Trecho
    </button>

    <!-- InformaÃ§Ãµes do Evento -->
    <h3 style="margin-top: 30px; margin-bottom: 15px; color: #2d8659;">ğŸ“… InformaÃ§Ãµes do Evento</h3>
    <div class="form-row">
      <div class="form-group">
        <label>Quantidade de dias no evento *</label>
        <input type="number" formControlName="diasNoEvento" min="1" placeholder="Ex: 3" [class.error]="campoInvalido('diasNoEvento')">
        <small style="color: #666;">Quantos dias vocÃª ficarÃ¡ participando do evento?</small>
        <div class="error-message" *ngIf="campoInvalido('diasNoEvento')">
          Informe quantos dias vocÃª ficarÃ¡ no evento
        </div>
      </div>
    </div>

    <!-- Viagem de Ida e Volta - Melhorado -->
    <div class="ida-volta-container" style="margin-top: 20px; padding: 20px; background: linear-gradient(135deg, #e8f5e9 0%, #f1f8e9 100%); border-radius: 12px; border: 2px solid #4caf50;">
      <div style="display: flex; align-items: center; gap: 15px; cursor: pointer;" (click)="toggleIdaEVolta()">
        <div class="toggle-switch" [class.active]="formulario.get('idaEVolta')?.value">
          <div class="toggle-slider"></div>
        </div>
        <div style="flex: 1;">
          <label style="font-weight: 600; color: #2d8659; font-size: 1.1em; cursor: pointer; margin: 0; display: flex; align-items: center; gap: 8px;">
            <span>ğŸ”„</span>
            <span>Viagem de Ida e Volta</span>
          </label>
          <p style="margin: 8px 0 0 0; color: #555; font-size: 0.95em; line-height: 1.5;">
            <span *ngIf="!formulario.get('idaEVolta')?.value">
              VocÃª estÃ¡ calculando apenas a ida. Marque esta opÃ§Ã£o se tambÃ©m retornarÃ¡ ao local de origem.
            </span>
            <span *ngIf="formulario.get('idaEVolta')?.value" style="color: #2d8659; font-weight: 500;">
              âœ“ O cÃ¡lculo incluirÃ¡ a viagem de ida e volta. A emissÃ£o serÃ¡ calculada para ambos os trajetos.
            </span>
          </p>
        </div>
      </div>
      <input type="checkbox" formControlName="idaEVolta" style="display: none;">
    </div>

    <!-- ObservaÃ§Ãµes -->
    <div class="form-group" style="margin-top: 20px;">
      <label>ObservaÃ§Ãµes</label>
      <textarea formControlName="observacoes" rows="3" placeholder="InformaÃ§Ãµes adicionais sobre a viagem..."></textarea>
    </div>

    <!-- BotÃµes -->
    <div style="margin-top: 30px; display: flex; gap: 15px;">
      <button type="submit" [disabled]="calculado || carregando">
        <span *ngIf="!carregando">ğŸ”¢ Calcular EmissÃ£o</span>
        <span *ngIf="carregando">â³ Calculando...</span>
      </button>
      <button type="button" (click)="resetarFormulario()" class="btn-secondary" [disabled]="carregando">ğŸ”„ Limpar</button>
    </div>
  </form>

  <!-- Loading -->
  <div *ngIf="carregando" class="loading">
    <p>â³ Calculando distÃ¢ncia e emissÃ£o de COâ‚‚...</p>
  </div>

  <!-- Resultado do CÃ¡lculo -->
  <div *ngIf="calculado && resultado && !carregando" class="result-card">
    <h3>ğŸ“Š Resultado do CÃ¡lculo</h3>
    <div *ngIf="formulario.get('idaEVolta')?.value" style="background: rgba(76, 175, 80, 0.2); padding: 12px; border-radius: 8px; margin-bottom: 15px; border-left: 4px solid #4caf50;">
      <p style="margin: 0; color: white; font-weight: 500; display: flex; align-items: center; gap: 8px;">
        <span>ğŸ”„</span>
        <span>Viagem de Ida e Volta - A emissÃ£o inclui ambos os trajetos</span>
      </p>
    </div>
    <div class="result-value">{{ resultado.emissaoCO2 }} kg COâ‚‚</div>
    <p style="margin: 15px 0;">
      <strong>DistÃ¢ncia Total:</strong> {{ resultado.distanciaTotal }} km
      <span *ngIf="formulario.get('idaEVolta')?.value" style="color: #4caf50; font-size: 0.9em; margin-left: 8px;">
        (ida + volta)
      </span>
    </p>
    
    <!-- Detalhes dos Trechos -->
    <div *ngIf="resultado.trechos && resultado.trechos.length > 0" style="margin-top: 20px; padding-top: 15px; border-top: 1px solid rgba(255,255,255,0.3);">
      <h4 style="color: white; margin-bottom: 10px;">
        Detalhes por Trecho:
        <span *ngIf="formulario.get('idaEVolta')?.value" style="font-size: 0.85em; color: #4caf50; margin-left: 8px;">
          (valores jÃ¡ incluem ida e volta)
        </span>
      </h4>
      <div *ngFor="let item of resultado.trechos; let i = index" style="margin-bottom: 10px; padding: 10px; background: rgba(255,255,255,0.1); border-radius: 6px;">
        <p style="margin: 5px 0;"><strong>Trecho {{ i + 1 }}:</strong> {{ formatarMeioTransporte(item.trecho.meioTransporte) }}</p>
        <p style="margin: 5px 0;">
          DistÃ¢ncia: {{ item.distancia }} km 
          <span *ngIf="formulario.get('idaEVolta')?.value" style="color: #4caf50; font-size: 0.9em;">
            ({{ item.distancia / 2 }} km Ã— 2)
          </span>
          | EmissÃ£o: {{ item.emissao }} kg COâ‚‚
          <span *ngIf="formulario.get('idaEVolta')?.value" style="color: #4caf50; font-size: 0.9em;">
            ({{ item.emissao / 2 }} kg Ã— 2)
          </span>
        </p>
      </div>
    </div>
    <p style="margin: 15px 0;">
      <strong>CrÃ©ditos de Carbono:</strong> {{ resultado.creditosCarbono }} toneladas de COâ‚‚ equivalente
    </p>
    <p style="margin: 10px 0;">
      <strong>Equivalente a:</strong> {{ resultado.equivalenteArvores }} Ã¡rvores plantadas
    </p>
    <p style="margin: 10px 0;">
      <strong>Ou:</strong> {{ resultado.equivalenteKmCarro }} km de carro
    </p>
    
    <button type="button" (click)="enviar()" [disabled]="enviado" style="margin-top: 20px;">
      {{ enviado ? 'âœ… Enviado com Sucesso!' : 'ğŸ’¾ Salvar CÃ¡lculo' }}
    </button>
    
    <div *ngIf="enviado" class="success-message" style="margin-top: 10px; color: white;">
      Seu cÃ¡lculo foi salvo! VocÃª pode visualizÃ¡-lo na pÃ¡gina de administrador.
    </div>
  </div>
</div>

